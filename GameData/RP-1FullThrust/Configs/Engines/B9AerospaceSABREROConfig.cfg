//SABRE
@PART[B9_Engine_SABRE_M]:FOR[RealismOverhaul]
{
	%RSSROConfig = true
	
	%rescaleFactor = 1.6
	
	%engineType = SABRE

	//reentry capable, just give shuttle stats
	%internalTempTag = Inconel
	%skinTempTag = RCC
	
	//Remove stock intake module and resources (because AJE doesn't)
	!RESOURCE[IntakeAtm] {}
	//keep IntakeAir though because it throws a NRE without it
	!MODULE[ModuleResourceIntake] {}
}


//	==================================================
//	Engine: SABRE Engine
//
//	Manufacturer: Reaction Engines Ltd.
//
//	=================================================================================
//	SABRE Engine Air Breathing
//	Skylon SSTO 2040
//
//	Dry Mass: 14000 Kg (1)
//	Thrust (Dry): 1960 kN (1)
//	Thrust (Wet): 1960 kN (1)
//	SFC (Dry): ??? lb/lbf-hr
//	Area: 4.5 m^2	//Compressor Area ?
//	BPR: 0			//Bypass Ratio ?
//	CPR: 140		//Compressor Pressure Ratio [1]
//	FPR: 5			//Fan Ratio?
//	Mdes: 5 M		//Mach Design Point
//	Tdes: 2450 K	//Temp Design Point ?
//	eta_n: 0.99		//Efficiency at afterburner rear / nozzle entrance ?
//	FHV: 90000000J	//Fuel heat of burning ~3x Kerosene by weight ?
//	TIT: 1800 K		//Combustion peak temp?
//	TAB: 2400 K		//Afterburner peak temp?
//	maxT3: 600 K	//Turbine max temperature?
//	Exhaust Mixer: true
//	Adjustable Nozzle: true
//	=================================================================================
//	SABRE Engine Closed Cycle
//	Skylon SSTO 2040
//
//	Dry Mass: 14000 Kg
//	Thrust (SL): 1960 kN
//	Thrust (Vac): 2940 kN		[1] 
//	ISP: 355 SL / 460 Vac		[1] 
//	Burn Time: unlimited
//	Chamber Pressure: 25 MPa
//	Chamber Temp: 2800 K
//	Propellant: LOX / LH2
//	Prop Ratio: 2.1		?
//	Throttle: 50%
//	Nozzle Ratio: 500	[1]
//	Ignitions: 60
//	=================================================================================

//	Sources:

//	(1)	Source 1																	https://en.wikipedia.org/wiki/SABRE_%28rocket_engine%29


//	Used by:

//	Notes:


//	Afterburner temp: Thrust ratio of an afterburner is equal to the square root of the afterburner temp over
//	the turbine outlet temp.
//	Based on a limited sample size (J79 and GE4), turbine outlet temp ~= TIT * 0.77
//	For a Turbofan, turbine gas is diluted by bypass air before combustion, reducing effective outlet temp.
//	So, TAB = (0.77 * (TIT *((1 + BPR) / (1 + BPR)) + 250 * (BPR / (1 + BPR))) * Thrust(Wet)^2)/(Thrust(Dry)^2)
//	Source: https://www.jet-x.org/a6.html
//	==================================================
@PART[*]:HAS[#engineType[SABRE]]:FOR[RealismOverhaulEngines]
{
	%category = Engine
	%title = SABRE
	%manufacturer = Reaction Engines Ltd
	%description = SABRE - Synergistic Airbreathing Rocket Engine

	@tags ^= :$: UK reactionengines airbreathing ssto spaceplane bimodial

	%specLevel = concept	//operational, prototype, concept, speculative, altHist, sciFi

//	!MODULE[ModuleEngines*],*{}
//	!MODULE[MultiModeEngine],*{}

	@MODULE[MultiModeEngine]
	{
		%primaryEngineID = AirBreathing
		@primaryEngineModeDisplayName = AirBreathing
		%secondaryEngineID = ClosedCycle
		@secondaryEngineModeDisplayName = ClosedCycle
		@autoSwitchAvailable = False
	}

	@MODULE[ModuleEngines*]:HAS[#engineID[AirBreathing]]
	{
		@name = ModuleEnginesAJEJet
		%EngineType = Turbine
		engineID = AirBreathing
		@PROPELLANT[LiquidFuel]
		{
			@name = LqdHydrogen
		}
	}

	@MODULE[ModuleEngines*]:HAS[#engineID[ClosedCycle]]
	{ 
		%EngineType = LiquidFuel
//		thrustVectorTransformName = thrustTransform
		engineID = ClosedCycle
		@PROPELLANT[LiquidFuel]
		{
			@name = LqdHydrogen
		}
		@PROPELLANT[Oxidizer]
		{
			@name = LqdOxygen
		}
		
	}

	@MODULE[ModuleGimbal]
	{
		%gimbalRange = 7
		%useGimbalResponseSpeed = true
		%gimbalResponseSpeed = 12
	}
	
	//Manually Adding an additional standard engine config as a base for the Ramjet
	MODULE
    {
        name = ModuleEnginesAJERamjet
		EngineType = Turbine
        engineID = AirBreathingRamjet
//      powerEffectName = power_open
//      runningEffectName = running_open
//      flameoutEffectName = flameout_open
	    thrustVectorTransformName = thrust_transform
        exhaustDamage = True
//      ignitionThreshold = 0.1
        minThrust = 0
        maxThrust = 480
        heatProduction = 100 // Modified in global config
        useEngineResponseTime = True
        engineAccelerationSpeed = 0.2
        engineDecelerationSpeed = 0.35
        useVelocityCurve = True
        PROPELLANT
        {
            name = LqdHydrogen
			resourceFlowMode = STAGE_STACK_FLOW_BALANCE
//          ratio = 1
//            DrawGauge = True
        }
        PROPELLANT
        {
            name = IntakeAir
            ignoreForIsp = True
			ratio = 9
        }
		atmosphereCurve
        {
            key = 0 4800 0 0
        }
		atmChangeFlow = True
		useVelCurve = True
		useAtmCurve = True
		flowMultCap = 5.0
        velCurve
		{
			key = 0 1 0 0
			key = 0.2 0.99 0 0
			key = 0.375 1.1875 1.5 1.5
			key = 1 2.75 3.25 3.25
			key = 2 6.5 2.5 2.5
			key = 4.5 9 0 0
			key = 6 0 -15 0
		}
		atmCurve
		{
			// higher thrust at altitude than even TRJ
			key = 0 0 0 0
			key = 0.018 0.09 7.914787 7.914787
			key = 0.08 0.3 1.051923 1.051923
			key = 0.35 0.5 0.3927226 0.3927226
			key = 1 1 1.055097 0
		}
    }
	MODULE
	{
		name = ModuleEngineConfigs
		type = ModuleEnginesAJEJet
		configuration = SABREAirBreathing
		engineID = AirBreathing
		modded = True
		isMaster = True
		origMass = 7		

		CONFIG
		{
			name = SABREAirBreathing
			description = High Speed Air Breathing Rocket for Mach 5+
			specLevel = concept
			massMult = 1.00
			heatProduction = 10
			
			Area = 0.7		//Compressor Area
			BPR = 0.0		//Bypass Ratio
			CPR = 140.0		//Compressor Pressure Ratio
			FPR = 0.0		//Fan Ratio
			Mdes = 0.9		//Mach Design Point
			Tdes = 250		//Temp Design Point
			eta_c = 0.95	//Efficiency at burner inlet
			eta_t = 0.98	//Efficiency at burner exit
			eta_n = 0.9		//Efficiency at afterburner rear / nozzle entrance
			FHV = 92000000	//Fuel heat of burning (joules?)
			TIT = 2200		//Combustion peak temp
			TAB = 3800		//Afterburner temp?
			maxT3 = 2500	//Turbine max temperature
			exhaustMixer = True
			adjustableNozzle = True
			thrustUpperLimit = 2500
			
			// Engine fitting params
			defaultTPR = 1
			dryThrust = 1200
			wetThrust = 2000
			maxThrust = 2000	//Just to let MEC know thrust
			drySFC = 0.5
			throttleResponseMultiplier = 0.96
			%areaFudgeFactor = 0.5
			PROPELLANT
			{
				name = LqdHydrogen
				ratio = 1.0
				DrawGauge = True
			}
			
			OtherModules
			{	
				BackupEngine = AirBreathingRamjet
			}
		}
	}
	
	MODULE
	{
		name = ModuleEngineConfigs
		type = ModuleEnginesAJERamjet
		configuration = AirBreathingRamjet
		modded = True
		isMaster = False
		engineID = AirBreathingRamjet
		

		CONFIG
		{
			name = AirBreathingRamjet
			description = 
			specLevel = concept
			massMult = 1.00
			heatProduction = 10
			
			Area = 2.4		//Compressor Area
			Mdes = 2.00		//Mach Design Point
			Tdes = 210		//Temp Design Point
			eta_n = 0.99	//Efficiency at afterburner rear / nozzle entrance
			FHV = 92000000	//Fuel heat of burning (joules?)
			maxFar = 0.1
			maxEngineTemp = 3000
			thrustUpperLimit = 3000
			
			// Engine fitting params
			maxThrust = 2000	//Just to let MEC know thrust
			throttleResponseMultiplier = 0.96
			//%areaFudgeFactor = 0.15

			PROPELLANT
			{
				name = LqdHydrogen
				ratio = 1.0
				DrawGauge = True
			}

		}
	}

	
	MODULE
	{
		name = ModuleEngineConfigs
		type = ModuleEngines
		configuration = SABRE-ClosedCycle
		modded = True
		engineID = ClosedCycle
//		runningEffectName = running_closed
//      flameoutEffectName = flameout_closed
//      thrustVectorTransformName = thrust_transform
		
		CONFIG
		{
			name = SABREClosedCycle
			//description 
			ignitionThreshold = 0.511
			specLevel = concept
			maxThrust = 2940
			minThrust = 1500
			heatProduction = 10
			massMult = 1.0
			pressureFed = False
			ullage = True
			ignitions = 0
			PROPELLANT
			{
				name = LqdOxygen
				ratio = 0.3
				DrawGauge = true
			}
			PROPELLANT
			{
				name = LqdHydrogen
				ratio = 0.7
			}
			atmosphereCurve
			{
				key = 0 460
				key = 1 307
			}		
		}
	}	
}